# Railway Deployment Configuration

> **Last Updated**: 2025-10-26
> **Version**: 1.1

This document describes the Railway.app deployment configuration for all services in the Job Application System.

---

## Overview

The system is deployed on Railway.app with the following services:
- PostgreSQL (database)
- PostgREST (auto-generated REST API)
- n8n (workflow automation engine)
- Next.js (frontend application)

---

## PostgreSQL Service

**Service Type**: Railway PostgreSQL Database

**Configuration**:
- Database Name: `jobapp`
- Port: 5432
- Internal URL: `postgres.railway.internal`
- Connection pooling: Managed by Railway

**Environment Variables**:
- `POSTGRES_USER`: Auto-generated by Railway
- `POSTGRES_PASSWORD`: Auto-generated by Railway
- `POSTGRES_DB`: `jobapp`

---

## PostgREST Service

**Service Type**: Docker Image
**Image**: `postgrest/postgrest:latest`

**Environment Variables**:
```bash
PGRST_DB_URI=postgresql://<user>:<password>@postgres.railway.internal:5432/jobapp
PGRST_DB_SCHEMA=public
PGRST_DB_ANON_ROLE=web_anon
PGRST_SERVER_PORT=3000
```

**Exposed Port**: 3000

**Public URL**: Provided by Railway (e.g., `https://postgrest-production-xxx.railway.app`)

---

## n8n Workflow Engine

**Service Type**: Docker Image
**Image**: `n8nio/n8n:latest`

**Environment Variables**:
```bash
# Authentication
N8N_BASIC_AUTH_ACTIVE=true
N8N_BASIC_AUTH_USER=admin
N8N_BASIC_AUTH_PASSWORD=OoK"ai4oiBei1mie

# Host Configuration
N8N_HOST=n8n-production-d194.up.railway.app
N8N_PORT=5678
N8N_PROTOCOL=https
WEBHOOK_URL=https://n8n-production-d194.up.railway.app/webhook

# Database Connection (PostgreSQL persistence)
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=pgvector.railway.internal
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=jobapp
DB_POSTGRESDB_USER=postgres
DB_POSTGRESDB_PASSWORD=nrro5u7845jcfg47q0gnyjvsbmm4wkkg
```

**Exposed Port**: 5678

**Public URL**: Provided by Railway (e.g., `https://n8n-production-xxx.railway.app`)

**Access**: Navigate to public URL, login with configured basic auth credentials

**Database Tables Created**:
- `n8n_workflow` - Workflow definitions
- `n8n_execution` - Execution history
- `n8n_credentials` - Encrypted credentials

---

## Next.js Application

**Service Type**: Next.js
**Build Command**: `npm run build`
**Start Command**: `npm start`

**Environment Variables**:
```bash
# Database Connection (PostgREST)
NEXT_PUBLIC_API_URL=<postgrest-railway-url>

# n8n Integration
N8N_URL=<n8n-railway-url>
N8N_WEBHOOK_SECRET=<webhook-secret>

# OpenAI
OPENAI_API_KEY=<api-key>

# PostgreSQL Direct Connection (for migrations)
DATABASE_URL=postgresql://<user>:<password>@postgres.railway.internal:5432/jobapp
```

**Exposed Port**: 3000

**Public URL**: Custom domain or Railway-provided URL

---

## Internal Networking

Railway provides internal networking between services:
- Services can communicate via `<service-name>.railway.internal`
- PostgreSQL: `postgres.railway.internal:5432`
- No need for public URLs for service-to-service communication
- More secure (internal traffic not exposed)

---

## Deployment Process

### Initial Setup

1. **Create Railway Project**
   ```bash
   # Install Railway CLI
   npm i -g @railway/cli

   # Login
   railway login

   # Link project
   railway link
   ```

2. **Add PostgreSQL**
   - Click "New" → "Database" → "PostgreSQL"
   - Railway auto-configures connection variables

3. **Add Services**
   - Click "New" → "Docker Image" or "GitHub Repo"
   - Configure environment variables
   - Expose required ports

### Deploying Updates

**Automatic Deployment** (GitHub integration):
- Push to `main` branch triggers deployment
- Railway builds and deploys automatically

**Manual Deployment** (CLI):
```bash
railway up
```

---

## Environment Variables Management

### Viewing Variables
```bash
railway variables
```

### Setting Variables
```bash
railway variables set KEY=value
```

### Service-Specific Variables
- Set in Railway dashboard under service settings
- Variables are encrypted at rest
- Use for secrets (API keys, passwords, etc.)

---

## Monitoring and Logs

### View Logs
```bash
railway logs
```

### Service Health
- Check Railway dashboard for service status
- Monitor resource usage (CPU, memory)
- Set up alerts for downtime

---

## Security Best Practices

- ✅ Use Railway internal networking for service-to-service communication
- ✅ Store all secrets in Railway environment variables (never in code)
- ✅ Enable basic auth for n8n web interface
- ✅ Use HTTPS for all public endpoints (automatic with Railway)
- ✅ Restrict PostgreSQL access to internal network only
- ✅ Use strong passwords for all services
- ✅ Rotate credentials regularly

---

## Troubleshooting

### Service Won't Start
1. Check Railway logs for errors
2. Verify all environment variables are set
3. Confirm port configuration matches Dockerfile/service
4. Check resource limits (CPU/memory)

### Database Connection Issues
1. Verify `DATABASE_URL` format is correct
2. Check PostgreSQL service is running
3. Confirm database name exists
4. Test connection with `psql` CLI

### n8n Issues
1. Check n8n service logs in Railway
2. Verify PostgreSQL connection variables
3. Confirm port 5678 is exposed
4. Test basic auth credentials

---

## Cost Optimization

**Railway Pricing** (as of Oct 2024):
- Free tier: $5 credit/month
- Pro plan: Pay for resources used
- PostgreSQL: ~$5-10/month
- Services: Based on CPU/memory usage

**Tips**:
- Use Railway internal networking (free)
- Scale services based on actual usage
- Monitor resource usage regularly
- Use scheduled workflows in n8n (not continuous polling)

---

## Backup and Recovery

### Database Backups
- Railway provides automatic daily backups
- Retain backups for 7 days on free tier
- Export database manually for additional safety:
  ```bash
  railway run pg_dump > backup.sql
  ```

### n8n Workflow Backups
- Export workflows as JSON files
- Commit to git repository (`/apps/n8n-workflows/`)
- Re-import in case of service recreation

---
